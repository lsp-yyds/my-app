name: Smart Build Fixed
on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version'
        required: true
        default: '3.11'
        type: choice
        options:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
      macos_version:
        description: 'Minimum macOS version'
        required: true
        default: '12.0'
        type: choice
        options:
          - '11.0'
          - '12.0'
          - '13.0'
          - '14.0'
jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ github.event.inputs.python_version || '3.11' }}
    
    - name: Install PyInstaller
      run: pip install pyinstaller
    
    - name: Clean previous builds
      run: rm -rf build dist __pycache__
    
    - name: Build with simple name
      env:
        MACOSX_DEPLOYMENT_TARGET: ${{ github.event.inputs.macos_version || '12.0' }}
      run: |
        echo "Building for macOS $MACOSX_DEPLOYMENT_TARGET with Python ${{ github.event.inputs.python_version || '3.11' }}"
        
        # 使用简单固定的文件名
        pyinstaller --onefile --name "myapp" main.py
        
        # 检查是否成功
        if [ -f "dist/myapp" ]; then
          echo "✅ Build successful!"
          ls -lh dist/
          file dist/myapp
        else
          echo "❌ Build failed: dist/myapp not found"
          exit 1
        fi
    
    - name: Rename with version info
      run: |
        # 获取 commit hash
        COMMIT_HASH=$(git rev-parse --short HEAD)
        # 获取 Python 版本
        PYTHON_VERSION=$(python -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
        # 获取 macOS 目标版本
        MACOS_TARGET=${MACOSX_DEPLOYMENT_TARGET:-12.0}
        
        # 重命名文件
        NEW_NAME="myapp_py${PYTHON_VERSION}_macos${MACOS_TARGET}_${COMMIT_HASH}"
        mv dist/myapp "dist/${NEW_NAME}"
        
        echo "✅ Renamed to: ${NEW_NAME}"
        echo "NEW_NAME=${NEW_NAME}" >> $GITHUB_ENV
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: myapp-${{ github.sha }}
        path: dist/
        retention-days: 7