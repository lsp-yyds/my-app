name: Smart Build Fixed
on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version'
        required: true
        default: '3.11'
        type: choice
        options:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
      macos_version:
        description: 'Minimum macOS version'
        required: true
        default: '12.0'
        type: choice
        options:
          - '11.0'
          - '12.0'
          - '13.0'
          - '14.0'
jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ github.event.inputs.python_version || '3.11' }}
    
    - name: Install PyInstaller
      run: pip install pyinstaller
    
    - name: Clean previous builds
      run: rm -rf build dist __pycache__
    
    - name: Build as macOS App
      env:
        MACOSX_DEPLOYMENT_TARGET: ${{ github.event.inputs.macos_version || '12.0' }}
      run: |
        echo "Building for macOS $MACOSX_DEPLOYMENT_TARGET with Python ${{ github.event.inputs.python_version || '3.11' }}"
        
        # å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ --windowed åˆ›å»º .app åº”ç”¨åŒ…
        pyinstaller \
          --windowed \  # åˆ›å»º macOS åº”ç”¨åŒ…
          --name "MyApp" \
          main.py
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
        if [ -d "dist/MyApp.app" ]; then
          echo "âœ… macOS App created successfully!"
          echo "ðŸ“ App location: dist/MyApp.app"
          
          # æ˜¾ç¤ºåº”ç”¨åŒ…ä¿¡æ¯
          echo "ðŸ“¦ App bundle contents:"
          find dist/MyApp.app -type f | head -10
          
          # èŽ·å–åº”ç”¨åŒ…å¤§å°
          APP_SIZE=$(du -sh dist/MyApp.app | cut -f1)
          echo "ðŸ“Š App size: $APP_SIZE"
        else
          echo "âŒ Build failed: MyApp.app not found"
          exit 1
        fi
    
    - name: Create DMG installer (å¯é€‰)
      run: |
        # åˆ›å»º DMG å®‰è£…åŒ…ï¼Œæ–¹ä¾¿åˆ†å‘
        echo "ðŸ“¦ Creating DMG installer..."
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p dmg_temp
        
        # å¤åˆ¶åº”ç”¨åˆ°ä¸´æ—¶ç›®å½•
        cp -r dist/MyApp.app dmg_temp/
        
        # åˆ›å»º Applications æ–‡ä»¶å¤¹é“¾æŽ¥
        ln -s /Applications dmg_temp/Applications
        
        # åˆ›å»º DMG
        hdiutil create \
          -volname "MyApp" \
          -srcfolder dmg_temp \
          -ov \
          -format UDZO \
          dist/MyApp.dmg
        
        echo "âœ… DMG created: dist/MyApp.dmg"
        ls -lh dist/*.dmg
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        rm -rf dmg_temp
    
    - name: Create launcher script (å¤‡ç”¨æ–¹æ¡ˆ)
      run: |
        # åŒæ—¶åˆ›å»ºä¸€ä¸ª .command æ–‡ä»¶ä½œä¸ºå¤‡ç”¨å¯åŠ¨æ–¹å¼
        echo "ðŸ”„ Creating launcher script..."
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > dist/LaunchMyApp.command << 'EOF'
        #!/bin/bash
        
        # èŽ·å–è„šæœ¬æ‰€åœ¨ç›®å½•
        SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
        
        echo "========================================"
        echo "   MyApp Launcher"
        echo "========================================"
        echo ""
        echo "Starting MyApp..."
        echo ""
        
        # æ‰“å¼€åº”ç”¨
        open "$SCRIPT_DIR/MyApp.app"
        
        echo "App launched! You can close this window."
        echo ""
        read -p "Press Enter to close..." dummy
        EOF
        
        # èµ‹äºˆæ‰§è¡Œæƒé™
        chmod +x dist/LaunchMyApp.command
        
        echo "âœ… Launcher created: dist/LaunchMyApp.command"
    
    - name: Create README for users
      run: |
        echo "ðŸ“ Creating user instructions..."
        
        cat > dist/README.txt << 'EOF'
        ========================================
        MyApp - Installation and Usage
        ========================================
        
        ðŸŽ¯ TWO WAYS TO RUN:
        
        1. EASY WAY (Recommended):
           - Double-click "MyApp.app"
           - If macOS blocks it, go to:
             System Preferences â†’ Security & Privacy â†’ General
             Click "Allow Anyway"
        
        2. ALTERNATIVE WAY:
           - Double-click "LaunchMyApp.command"
           - Follow the instructions in the terminal
        
        ðŸ“¦ DMG INSTALLER:
        - Double-click "MyApp.dmg"
        - Drag "MyApp.app" to the Applications folder
        
        ðŸ”§ TROUBLESHOOTING:
        
        If you see "App is damaged":
          1. Open Terminal
          2. Run: xattr -cr /path/to/MyApp.app
        
        If you see "Cannot be opened":
          1. Right-click the app
          2. Select "Open"
          3. Click "Open" in the dialog
        
        ========================================
        Built on: $(date)
        macOS Target: ${{ github.event.inputs.macos_version || '12.0' }}
        Python Version: ${{ github.event.inputs.python_version || '3.11' }}
        ========================================
        EOF
        
        echo "âœ… README created"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MyApp-macos-${{ github.sha }}
        path: |
          dist/MyApp.app
          dist/MyApp.dmg
          dist/LaunchMyApp.command
          dist/README.txt
        retention-days: 7