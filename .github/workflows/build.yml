name: Smart Build Fixed
on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version'
        required: true
        default: '3.11'
        type: choice
        options:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
      macos_version:
        description: 'Minimum macOS version'
        required: true
        default: '12.0'
        type: choice
        options:
          - '11.0'
          - '12.0'
          - '13.0'
          - '14.0'
      script_file:
        description: 'Main script file name'
        required: true
        default: 'main.py'
        type: string
jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: List files in repository
      run: |
        echo "ðŸ“ Files in repository:"
        ls -la
        echo ""
        echo "ðŸ“„ Python files:"
        find . -name "*.py" -type f | head -20
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ github.event.inputs.python_version || '3.11' }}
    
    - name: Install PyInstaller
      run: pip install pyinstaller
    
    - name: Clean previous builds
      run: rm -rf build dist __pycache__
    
    - name: Find main script
      id: find_script
      run: |
        # å°è¯•æ‰¾åˆ°ä¸»è„šæœ¬æ–‡ä»¶
        SCRIPT_FILE="${{ github.event.inputs.script_file || 'main.py' }}"
        
        if [ -f "$SCRIPT_FILE" ]; then
          echo "âœ… Found script: $SCRIPT_FILE"
          echo "script_path=$SCRIPT_FILE" >> $GITHUB_OUTPUT
        else
          # å°è¯•è‡ªåŠ¨æŸ¥æ‰¾
          echo "âš ï¸ $SCRIPT_FILE not found, searching for alternatives..."
          
          # æŸ¥æ‰¾å¯èƒ½çš„å…¥å£æ–‡ä»¶
          POSSIBLE_FILES=("main.py" "app.py" "cli.py" "gui.py" "run.py" "start.py")
          
          for file in "${POSSIBLE_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found alternative: $file"
              echo "script_path=$file" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
          
          # æŸ¥æ‰¾ä»»ä½• .py æ–‡ä»¶
          FIRST_PY=$(find . -name "*.py" -type f | head -1)
          if [ -n "$FIRST_PY" ]; then
            echo "âœ… Using first Python file found: $FIRST_PY"
            echo "script_path=$FIRST_PY" >> $GITHUB_OUTPUT
          else
            echo "âŒ No Python files found in repository!"
            echo "Available files:"
            ls -la
            exit 1
          fi
        fi
    
    - name: Build as macOS App
      env:
        MACOSX_DEPLOYMENT_TARGET: ${{ github.event.inputs.macos_version || '12.0' }}
      run: |
        echo "Building for macOS $MACOSX_DEPLOYMENT_TARGET with Python ${{ github.event.inputs.python_version || '3.11' }}"
        
        # èŽ·å–è„šæœ¬è·¯å¾„
        SCRIPT_PATH="${{ steps.find_script.outputs.script_path }}"
        echo "ðŸ“„ Using script: $SCRIPT_PATH"
        
        # æå–æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰
        APP_NAME=$(basename "$SCRIPT_PATH" .py)
        # ç¡®ä¿åç§°é¦–å­—æ¯å¤§å†™
        APP_NAME=$(echo "$APP_NAME" | sed 's/^./\U&/')
        
        echo "ðŸ“± App name will be: $APP_NAME"
        
        # æž„å»ºåº”ç”¨
        pyinstaller \
          --windowed \
          --name "$APP_NAME" \
          "$SCRIPT_PATH"
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
        if [ -d "dist/${APP_NAME}.app" ]; then
          echo "âœ… macOS App created successfully!"
          echo "ðŸ“ App location: dist/${APP_NAME}.app"
          
          # æ˜¾ç¤ºåº”ç”¨åŒ…ä¿¡æ¯
          echo "ðŸ“¦ App bundle contents:"
          find "dist/${APP_NAME}.app" -type f | head -10
          
          # èŽ·å–åº”ç”¨åŒ…å¤§å°
          APP_SIZE=$(du -sh "dist/${APP_NAME}.app" | cut -f1)
          echo "ðŸ“Š App size: $APP_SIZE"
          
          # ä¿å­˜åº”ç”¨åç§°åˆ°çŽ¯å¢ƒå˜é‡
          echo "APP_NAME=${APP_NAME}" >> $GITHUB_ENV
        else
          echo "âŒ Build failed: ${APP_NAME}.app not found"
          echo "Checking dist directory:"
          ls -la dist/
          exit 1
        fi
    
    - name: Create launcher script
      run: |
        APP_NAME="${{ env.APP_NAME }}"
        
        echo "ðŸ”„ Creating launcher script for $APP_NAME..."
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > "dist/Launch ${APP_NAME}.command" << EOF
        #!/bin/bash
        
        # èŽ·å–è„šæœ¬æ‰€åœ¨ç›®å½•
        SCRIPT_DIR="\$( cd "\$( dirname "\${BASH_SOURCE[0]}" )" && pwd )"
        
        echo "========================================"
        echo "   $APP_NAME Launcher"
        echo "========================================"
        echo ""
        echo "Starting $APP_NAME..."
        echo ""
        
        # æ‰“å¼€åº”ç”¨
        open "\$SCRIPT_DIR/${APP_NAME}.app"
        
        echo "App launched! You can close this window."
        echo ""
        read -p "Press Enter to close..." dummy
        EOF
        
        # èµ‹äºˆæ‰§è¡Œæƒé™
        chmod +x "dist/Launch ${APP_NAME}.command"
        
        echo "âœ… Launcher created: dist/Launch ${APP_NAME}.command"
    
    - name: Create README for users
      run: |
        APP_NAME="${{ env.APP_NAME }}"
        
        echo "ðŸ“ Creating user instructions..."
        
        cat > "dist/README.txt" << EOF
        ========================================
        $APP_NAME - Installation and Usage
        ========================================
        
        ðŸŽ¯ HOW TO RUN:
        
        1. EASY WAY (Recommended):
           - Double-click "${APP_NAME}.app"
           - If macOS blocks it, go to:
             System Preferences â†’ Security & Privacy â†’ General
             Click "Allow Anyway"
        
        2. ALTERNATIVE WAY:
           - Double-click "Launch ${APP_NAME}.command"
           - Follow the instructions in the terminal
        
        ðŸ”§ TROUBLESHOOTING:
        
        If you see "App is damaged":
          1. Open Terminal
          2. Run: xattr -cr /path/to/${APP_NAME}.app
        
        If you see "Cannot be opened":
          1. Right-click the app
          2. Select "Open"
          3. Click "Open" in the dialog
        
        ========================================
        Built on: $(date)
        macOS Target: ${{ github.event.inputs.macos_version || '12.0' }}
        Python Version: ${{ github.event.inputs.python_version || '3.11' }}
        ========================================
        EOF
        
        echo "âœ… README created"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-macos-${{ github.sha }}
        path: |
          dist/${{ env.APP_NAME }}.app
          dist/Launch*.command
          dist/README.txt
        retention-days: 7
