name: Smart Build Fixed for Intel Mac
on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version'
        required: true
        default: '3.11'
        type: choice
        options:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
      macos_version:
        description: 'Minimum macOS version'
        required: true
        default: '12.0'
        type: choice
        options:
          - '11.0'
          - '12.0'
          - '13.0'
          - '14.0'
jobs:
  build:
    runs-on: macos-latest  # ËøôÊòØ Apple SiliconÔºå‰ΩÜÊàë‰ª¨‰ºöÊûÑÂª∫ÈÄöÁî®‰∫åËøõÂà∂
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python for Intel
      uses: actions/setup-python@v5
      with:
        python-version: ${{ github.event.inputs.python_version || '3.11' }}
        architecture: 'x64'  # Âº∫Âà∂‰ΩøÁî® x86_64 Python
    
    - name: Install PyInstaller
      run: pip install pyinstaller
    
    - name: Clean previous builds
      run: rm -rf build dist __pycache__
    
    - name: Build for Intel Mac (x86_64)
      env:
        MACOSX_DEPLOYMENT_TARGET: ${{ github.event.inputs.macos_version || '12.0' }}
      run: |
        echo "Building for Intel Mac (x86_64)"
        echo "macOS target: $MACOSX_DEPLOYMENT_TARGET"
        echo "Python version: ${{ github.event.inputs.python_version || '3.11' }}"
        
        # Ê£ÄÊü•Êû∂ÊûÑ
        echo "üìä System info:"
        uname -m
        python -c "import platform; print(f'Python arch: {platform.machine()}')"
        
        # ÂÖ≥ÈîÆÔºö‰ΩøÁî® arch ÂëΩ‰ª§Âº∫Âà∂Âú® Rosetta 2 ‰∏ãËøêË°å
        echo "üîß Building with Rosetta 2 for Intel compatibility..."
        
        # ÊñπÊ≥ï1Ôºö‰ΩøÁî® arch ÂëΩ‰ª§Âº∫Âà∂ x86_64
        arch -x86_64 /bin/bash -c "
          # Âú® x86_64 ÁéØÂ¢É‰∏≠ÊûÑÂª∫
          echo 'Building in x86_64 mode...'
          pip install pyinstaller
          
          # ÊûÑÂª∫Â∫îÁî®
          pyinstaller \
            --windowed \
            --name 'MyApp' \
            --target-arch x86_64 \
            main.py
        "
        
        # Ê£ÄÊü•ÊòØÂê¶ÊàêÂäü
        if [ -d "dist/MyApp.app" ]; then
          echo "‚úÖ Intel macOS App created successfully!"
          
          # Ê£ÄÊü•‰∫åËøõÂà∂Êû∂ÊûÑ
          echo "üì¶ Checking binary architecture:"
          file "dist/MyApp.app/Contents/MacOS/MyApp" || true
          
          # ‰ΩøÁî® lipo Ê£ÄÊü•ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
          if command -v lipo &> /dev/null; then
            lipo -archs "dist/MyApp.app/Contents/MacOS/MyApp" 2>/dev/null || echo "Cannot check with lipo"
          fi
          
          echo "üìÅ App location: dist/MyApp.app"
          APP_SIZE=$(du -sh dist/MyApp.app | cut -f1)
          echo "üìä App size: $APP_SIZE"
        else
          echo "‚ùå Build failed: MyApp.app not found"
          exit 1
        fi
    
    - name: Create universal binary (ÂèØÈÄâ - ÂêåÊó∂ÊîØÊåÅ Intel Âíå Apple Silicon)
      if: false  # ÈªòËÆ§Á¶ÅÁî®ÔºåÈúÄË¶ÅÊó∂ÂêØÁî®
      run: |
        echo "üîÑ Creating universal binary..."
        
        # È¶ñÂÖàÊûÑÂª∫ arm64 ÁâàÊú¨
        arch -arm64 /bin/bash -c "
          echo 'Building arm64 version...'
          pip install pyinstaller
          pyinstaller \
            --windowed \
            --name 'MyApp_arm64' \
            --target-arch arm64 \
            --distpath dist_arm64 \
            main.py
        "
        
        # ÂàõÂª∫ÈÄöÁî®‰∫åËøõÂà∂
        lipo -create \
          "dist/MyApp.app/Contents/MacOS/MyApp" \
          "dist_arm64/MyApp_arm64.app/Contents/MacOS/MyApp_arm64" \
          -output "dist/MyApp.app/Contents/MacOS/MyApp"
        
        echo "‚úÖ Universal binary created!"
        lipo -archs "dist/MyApp.app/Contents/MacOS/MyApp"
    
    - name: Create DMG installer for Intel Mac
      run: |
        echo "üì¶ Creating DMG installer for Intel Mac..."
        
        # ÂàõÂª∫‰∏¥Êó∂ÁõÆÂΩï
        mkdir -p dmg_temp
        
        # Â§çÂà∂Â∫îÁî®Âà∞‰∏¥Êó∂ÁõÆÂΩï
        cp -r dist/MyApp.app dmg_temp/
        
        # ÂàõÂª∫ Applications Êñá‰ª∂Â§πÈìæÊé•
        ln -s /Applications dmg_temp/Applications
        
        # Ê∑ªÂä†ËØ¥ÊòéÊñá‰ª∂
        cat > dmg_temp/README-Intel-Mac.txt << 'EOF'
        ========================================
        MyApp for Intel Mac (x86_64)
        ========================================
        
        ‚úÖ This app is built specifically for:
           - Intel-based Macs
           - macOS 12.0 or later
           - x86_64 architecture
        
        üöÄ HOW TO INSTALL:
        1. Double-click this DMG file
        2. Drag "MyApp.app" to the Applications folder
        3. Launch from Applications
        
        üîß TROUBLESHOOTING for Intel Mac:
        
        If app won't open:
          xattr -cr /Applications/MyApp.app
        
        For macOS 12.7.6 specifically:
          - Right-click the app
          - Select "Open"
          - Click "Open" in the dialog
        
        ========================================
        Built for: Intel x86_64 Mac
        macOS Target: ${{ github.event.inputs.macos_version || '12.0' }}
        ========================================
        EOF
        
        # ÂàõÂª∫ DMG
        hdiutil create \
          -volname "MyApp for Intel Mac" \
          -srcfolder dmg_temp \
          -ov \
          -format UDZO \
          dist/MyApp-Intel-Mac.dmg
        
        echo "‚úÖ DMG created: dist/MyApp-Intel-Mac.dmg"
        ls -lh dist/*.dmg
        
        # Ê∏ÖÁêÜ‰∏¥Êó∂ÁõÆÂΩï
        rm -rf dmg_temp
    
    - name: Create launcher script for Intel
      run: |
        echo "üîÑ Creating launcher script for Intel Mac..."
        
        # ÂàõÂª∫ÂêØÂä®ËÑöÊú¨
        cat > dist/LaunchMyApp-Intel.command << 'EOF'
        #!/bin/bash
        
        # ========================================
        # MyApp Launcher for Intel Mac
        # ========================================
        
        echo "========================================"
        echo "   MyApp Launcher (Intel Mac)"
        echo "========================================"
        echo ""
        echo "This app is built for Intel-based Macs."
        echo "Compatible with macOS 12.0 and later."
        echo ""
        
        # Ëé∑ÂèñËÑöÊú¨ÊâÄÂú®ÁõÆÂΩï
        SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
        APP_PATH="$SCRIPT_DIR/MyApp.app"
        
        # Ê£ÄÊü•Â∫îÁî®ÊòØÂê¶Â≠òÂú®
        if [ ! -d "$APP_PATH" ]; then
          echo "‚ùå ERROR: MyApp.app not found!"
          echo "Make sure this script is in the same folder as MyApp.app"
          read -p "Press Enter to close..." dummy
          exit 1
        fi
        
        # Ê£ÄÊü•Êû∂ÊûÑ
        echo "üîç Checking system architecture..."
        ARCH=$(uname -m)
        echo "System architecture: $ARCH"
        
        if [ "$ARCH" = "x86_64" ]; then
          echo "‚úÖ Running on Intel Mac - perfect match!"
        elif [ "$ARCH" = "arm64" ]; then
          echo "‚ö†Ô∏è  Running on Apple Silicon Mac"
          echo "This app is built for Intel, will run via Rosetta 2"
        else
          echo "‚ö†Ô∏è  Unknown architecture"
        fi
        
        echo ""
        echo "üöÄ Starting MyApp..."
        echo ""
        
        # ÊâìÂºÄÂ∫îÁî®
        open "$APP_PATH"
        
        echo "App launched! You can close this window."
        echo ""
        read -p "Press Enter to close..." dummy
        EOF
        
        # Ëµã‰∫àÊâßË°åÊùÉÈôê
        chmod +x dist/LaunchMyApp-Intel.command
        
        echo "‚úÖ Launcher created: dist/LaunchMyApp-Intel.command"
    
    - name: Test on Intel architecture (Ê®°Êãü)
      run: |
        echo "üß™ Testing Intel compatibility..."
        
        if [ -f "dist/MyApp.app/Contents/MacOS/MyApp" ]; then
          # ‰ΩøÁî® arch ÂëΩ‰ª§Ê®°Êãü Intel ÁéØÂ¢ÉËøêË°å
          echo "Testing with arch -x86_64..."
          arch -x86_64 dist/MyApp.app/Contents/MacOS/MyApp --version 2>&1 || echo "Test completed"
          
          # Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
          echo "File info:"
          file dist/MyApp.app/Contents/MacOS/MyApp
        else
          echo "‚ö†Ô∏è  Executable not found for testing"
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MyApp-Intel-macOS-${{ github.sha }}
        path: |
          dist/MyApp.app
          dist/MyApp-Intel-Mac.dmg
          dist/LaunchMyApp-Intel.command
        retention-days: 7
